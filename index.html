<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Check-in</title>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:20px;max-width:900px;margin:auto;background:#f7fafc}
    header{text-align:center;margin:18px 0 18px}
    .card{background:#fff;border-radius:10px;padding:18px;border:1px solid #e6eef6;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{color:var(--muted);margin:0 0 12px}
    #signinBtn{display:inline-block;padding:10px 14px;border-radius:8px;background:#fff;border:1px solid #d1e3ff;color:#0b63d6;text-decoration:none}
    .btn{padding:10px 14px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px}
    .status{margin-top:12px;color:#111}
    .hint{background:#fffbe6;border:1px solid #ffe8a0;padding:10px;border-radius:8px;margin-bottom:12px;color:#7a4c00}
  </style>
</head>
<body>
  <header>
    <h1>Check In</h1>
    <p class="lead">B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang trang Google ƒë·ªÉ ƒëƒÉng nh·∫≠p, sau ƒë√≥ quay l·∫°i v√† c√≥ th·ªÉ check-in.</p>
  </header>

  <div class="card" id="card">
    <div id="beforeSignIn">
      <div class="hint" id="webviewHint" style="display:none"></div>

      <!-- LINK redirect (kh√¥ng popup) -->
      <a id="signinBtn" href="#" role="button">üîí ƒêƒÉng nh·∫≠p b·∫±ng Google</a>

      <div class="status" id="status">Tr·∫°ng th√°i: Ch∆∞a ƒëƒÉng nh·∫≠p</div>
    </div>

    <div id="afterSignIn" style="display:none">
      <div class="small">Email: <b id="userEmail"></b></div>
      <label for="userName" style="display:block;margin-top:8px;">T√™n hi·ªÉn th·ªã (c√≥ th·ªÉ s·ª≠a)</label>
      <input id="userName" type="text" placeholder="T√™n c·ªßa b·∫°n">
      <div style="margin-top:12px">
        <button id="btnCheckin" class="btn">Check in</button>
      </div>
      <div id="afterStatus" class="status"></div>
    </div>
  </div>

<script>
/* ========== C·∫§U H√åNH: THAY 3 CH·ªñ N√ÄY ========== */
const CLIENT_ID = '1046897683218-h0snmi82rtm2ep06fkepr4bt8eo1k84i.apps.googleusercontent.com'; // <-- ƒëi·ªÅn client id
const REDIRECT_URI = 'https://anhdvh99.github.io/Check_In_Web/'; // <-- ph·∫£i kh·ªõp v·ªõi Authorized redirect URIs
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwD686lDtOb4UtwvKDOncEUu55C7z1Ie02WD3urL41-iIzjFheRf9-fodDA5tkZhbQiMw/exec'; // <-- webapp exec
/* ============================================ */

// Helpers
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  return /(FBAN|FBAV|Instagram|Line|Zalo|MicroMessenger|Messenger)/i.test(ua);
}
function randNonce(len=16){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
  return s;
}

// Build OAuth2 implicit (OIDC) URL to get id_token via redirect (response_type=id_token)
// IMPORTANT: add REDIRECT_URI to Google Cloud OAuth 2.0 Client -> Authorized redirect URIs
function buildAuthUrl(){
  const nonce = randNonce(12);
  sessionStorage.setItem('oidc_nonce', nonce);
  const scope = encodeURIComponent('openid email profile');
  const url = 'https://accounts.google.com/o/oauth2/v2/auth' +
    '?client_id=' + encodeURIComponent(CLIENT_ID) +
    '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
    '&response_type=id_token' + // return id_token in fragment
    '&scope=' + scope +
    '&nonce=' + encodeURIComponent(nonce) +
    '&prompt=select_account'; // force account selection
  return url;
}

// Parse fragment (#id_token=...)
function parseHashParams() {
  const hash = window.location.hash.substring(1);
  if (!hash) return null;
  const parts = hash.split('&').map(p => p.split('='));
  const obj = {};
  parts.forEach(p=>{ if(p[0]) obj[decodeURIComponent(p[0])] = decodeURIComponent(p[1]||''); });
  return obj;
}

// Decode JWT payload (no verification client-side)
function decodeJwtPayload(id_token){
  try{
    const payload = id_token.split('.')[1];
    const json = atob(payload.replace(/-/g,'+').replace(/_/g,'/'));
    return JSON.parse(decodeURIComponent(escape(json)));
  }catch(e){ return null; }
}

// Remove hash from URL (clean)
function clearUrlHash(){
  if(history && history.replaceState){
    history.replaceState('', document.title, window.location.pathname + window.location.search);
  } else {
    window.location.hash = '';
  }
}

// UI elements
const signinBtn = document.getElementById('signinBtn');
const statusEl = document.getElementById('status');
const webviewHint = document.getElementById('webviewHint');
const before = document.getElementById('beforeSignIn');
const after = document.getElementById('afterSignIn');
const userEmailEl = document.getElementById('userEmail');
const userNameEl = document.getElementById('userName');
const btnCheckin = document.getElementById('btnCheckin');
const afterStatus = document.getElementById('afterStatus');

// If user opened in app webview, show hint and attempt to open Chrome
if(isInAppBrowser()){
  webviewHint.style.display = 'block';
  webviewHint.innerHTML = 'B·∫°n ƒëang m·ªü trong app (Zalo/Facebook...). ƒê·ªÉ ƒëƒÉng nh·∫≠p Google, b·∫•m "M·ªü trong tr√¨nh duy·ªát" n·∫øu c√≥, ho·∫∑c b·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ c·ªë m·ªü Chrome.';
  // add a visible "Open in browser" link instead of auto-intent (auto-intent can be blocked)
  const openLink = document.createElement('a'); openLink.href = window.location.href; openLink.target='_blank'; openLink.style.display='inline-block';
  openLink.textContent = 'M·ªü trong tr√¨nh duy·ªát';
  openLink.style.marginLeft = '8px';
  webviewHint.appendChild(openLink);
}

// Set sign-in link (redirect)
signinBtn.href = buildAuthUrl();
signinBtn.addEventListener('click', function(e){
  // nothing special ‚Äî it's a normal link that redirects
});

// On page load check if redirected from Google (has id_token in fragment)
window.addEventListener('load', function(){
  const hash = parseHashParams();
  if(hash && hash.id_token){
    const idt = hash.id_token;
    const payload = decodeJwtPayload(idt);
    // quick nonce check (optional)
    const savedNonce = sessionStorage.getItem('oidc_nonce');
    if(!payload){
      statusEl.innerText = 'Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c token tr·∫£ v·ªÅ t·ª´ Google.';
      clearUrlHash();
      return;
    }
    // You may check payload.nonce === savedNonce for extra safety
    // Save authorized user to sessionStorage
    sessionStorage.setItem('user_id_token', idt);
    sessionStorage.setItem('user_email', payload.email||'');
    sessionStorage.setItem('user_name', payload.name||'');
    clearUrlHash();
  }

  // If we have logged-in user info in sessionStorage -> show afterLogin UI
  const email = sessionStorage.getItem('user_email');
  const name = sessionStorage.getItem('user_name');
  if(email){
    showAfterLogin({email, name});
  } else {
    statusEl.innerText = 'Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Google (kh√¥ng d√πng popup).';
    before.style.display = 'block';
  }
});

// Show after sign-in UI
function showAfterLogin(user){
  before.style.display = 'none';
  after.style.display = 'block';
  userEmailEl.textContent = user.email;
  userNameEl.value = user.name || '';
  statusEl.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p: ' + user.email;
}

// Create and submit POST form to Apps Script (navigational POST -> load result page)
function submitPostToAppsScript(formData){
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = APPS_SCRIPT_URL;
  // add inputs
  for(const [k,v] of formData.entries()){
    const inp = document.createElement('input');
    inp.type = 'hidden'; inp.name = k; inp.value = v;
    form.appendChild(inp);
  }
  document.body.appendChild(form);
  form.submit(); // this will navigate to Apps Script response HTML
}

// On Check-in click -> get geolocation then submit navigational POST
btnCheckin.addEventListener('click', function(){
  btnCheckin.disabled = true;
  afterStatus.textContent = 'ƒêang l·∫•y v·ªã tr√≠...';

  if(!navigator.geolocation){
    afterStatus.textContent = 'Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.';
    btnCheckin.disabled = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(async function(pos){
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    afterStatus.textContent = `V·ªã tr√≠: ${lat.toFixed(6)}, ${lng.toFixed(6)} ‚Äî G·ª≠i...`;

    // optional: get IP via ipify to detect device uniqueness
    let ip = 'unknown';
    try{ const r = await fetch('https://api.ipify.org?format=json'); ip = (await r.json()).ip || 'unknown'; }catch(e){}

    const ua = navigator.userAgent;
    const email = sessionStorage.getItem('user_email') || '';
    const name = (userNameEl.value || '').trim();

    const data = new URLSearchParams();
    data.append('email', email);
    data.append('name', name);
    data.append('lat', lat.toString());
    data.append('lng', lng.toString());
    data.append('ip', ip);
    data.append('userAgent', ua);
    // optional: send id_token to server (server can verify on its side)
    const idtoken = sessionStorage.getItem('user_id_token');
    if(idtoken) data.append('id_token', idtoken);

    // navigational POST - will redirect to Apps Script response page (doPost returns HTML)
    submitPostToAppsScript(data);

  }, function(err){
    afterStatus.textContent = 'L·∫•y v·ªã tr√≠ th·∫•t b·∫°i: ' + (err.message||err.code);
    btnCheckin.disabled = false;
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:5000 });
});
</script>
</body>
</html>
