<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in Piacom</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:20px;max-width:900px;margin:auto}
    header{text-align:center;margin:18px 0 28px}
    h1{margin:0;font-size:1.6rem}
    p.lead{color:var(--muted);margin-top:6px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:16px;box-shadow:0 2px 6px rgba(2,6,23,0.03)}
    #g_button{display:flex;justify-content:center}
    .small{font-size:0.9rem;color:var(--muted)}
    .status{margin-top:14px;color:#333;font-size:0.95rem}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
    @media(max-width:420px){h1{font-size:1.25rem}}
  </style>
</head>
<body>
  <header>
    <h1>Điểm danh Piacom</h1>
    <p class="lead">Đăng nhập Google → Cho phép vị trí → Hệ thống ghi nhận</p>
  </header>

  <main>
    <section class="card">
      <div id="g_button"></div>

      <div id="afterLogin" style="display:none;margin-top:10px">
        <div class="small">Tài khoản: <b id="userEmail"></b></div>
        <div style="margin-top:8px">
          <button id="btnCheckin" class="btn">Check In</button>
        </div>
      </div>

      <div id="status" class="status">Trạng thái: Đang tải...</div>
    </section>
  </main>

<script>
/* ========== Cấu hình của bạn ========== */
const CLIENT_ID = '1046897683218-h0snmi82rtm2ep06fkepr4bt8eo1k84i.apps.googleusercontent.com';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwD686lDtOb4UtwvKDOncEUu55C7z1Ie02WD3urL41-iIzjFheRf9-fodDA5tkZhbQiMw/exec';
/* ===================================== */

const statusEl = document.getElementById('status');

function isInAppBrowser() {
  const ua = navigator.userAgent || '';
  return /(FBAN|FBAV|Instagram|Line|Zalo|KAKAOTALK|MicroMessenger|Messenger)/i.test(ua);
}

// Nếu mở trong Zalo → tự động mở bằng Chrome
if (isInAppBrowser()) {
  const url = window.location.href;
  if (/Android/i.test(navigator.userAgent)) {
    window.location.href = 'intent:' + url + '#Intent;scheme=https;package=com.android.chrome;end';
  } else if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    alert('⚠️ Hãy mở trang này bằng Safari để đăng nhập Google.');
  }
}

// Khởi tạo Google Sign-In
window.onload = function () {
  if (!window.google) {
    statusEl.innerText = 'Google Sign-In chưa sẵn sàng.';
    return;
  }

  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleGoogleLogin,
    ux_mode: 'popup'
  });

  google.accounts.id.renderButton(
    document.getElementById('g_button'),
    { theme: 'outline', size: 'large', text: 'signin_with' }
  );

  statusEl.innerText = 'Vui lòng đăng nhập Google để tiếp tục.';
};

// Xử lý phản hồi từ Google
function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

function handleGoogleLogin(resp) {
  const user = parseJwt(resp.credential);
  if (!user || !user.email) {
    statusEl.innerText = 'Không thể lấy thông tin tài khoản.';
    return;
  }

  document.getElementById('userEmail').innerText = user.email;
  document.getElementById('afterLogin').style.display = 'block';
  statusEl.innerText = 'Đã đăng nhập: ' + user.email;

  document.getElementById('btnCheckin').onclick = () => doCheckin(user);
}

// Gửi dữ liệu check-in
async function doCheckin(user) {
  if (!navigator.geolocation) {
    alert('Thiết bị không hỗ trợ định vị.');
    return;
  }

  statusEl.innerText = 'Đang lấy vị trí...';

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const userAgent = navigator.userAgent;
    const ip = await getIp();

    const payload = new URLSearchParams({
      email: user.email,
      name: user.name || '',
      lat: lat.toString(),
      lng: lng.toString(),
      userAgent,
      ip
    });

    statusEl.innerText = 'Đang gửi dữ liệu...';

    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: payload
    });

    const text = await res.text();
    statusEl.innerHTML = text.includes('✅')
      ? `<span style="color:green">${text}</span>`
      : `<span style="color:red">${text}</span>`;
  }, err => {
    alert('Không thể lấy vị trí: ' + err.message);
  }, { enableHighAccuracy: true, timeout: 10000 });
}

// Lấy IP thật của client (qua API public)
async function getIp() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return 'unknown';
  }
}
</script>
</body>
</html>
