<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in bằng Gmail (Hosted)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
    input, button { padding: 10px; font-size: 16px; margin: 8px 0; }
  </style>
</head>
<body>
  <h2>Check-in bằng Gmail</h2>
  <p>Đăng nhập bằng Google, cho phép lấy vị trí, hệ thống sẽ gửi dữ liệu lên Google Sheet.</p>

  <!-- Google Sign-in -->
  <div id="g_id_onload"
       data-client_id="1046897683218-h0snmi82rtm2ep06fkepr4bt8eo1k84i.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <div id="info" style="margin-top:20px"></div>
  <div id="manualName" style="display:none; margin-top:10px;">
    <input id="userName" placeholder="Nhập tên (nếu muốn sửa)" />
  </div>
  <div id="action" style="margin-top:12px;"></div>
  <p id="status" style="color:green"></p>

<script>
/* helper: parse JWT returned by GSI */
function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) { return null; }
}

function handleCredentialResponse(response) {
  const payload = parseJwt(response.credential);
  if (!payload) {
    document.getElementById('status').innerText = 'Không lấy được thông tin tài khoản.';
    return;
  }

  // user info from token
  const email = payload.email || '';
  const nameFromToken = payload.name || '';
  document.getElementById('info').innerHTML =
    `<b>${nameFromToken}</b> (${email}) đã đăng nhập.`;

  // show optional name input if you want override
  document.getElementById('manualName').style.display = 'block';

  // create Check-in button
  const actionDiv = document.getElementById('action');
  actionDiv.innerHTML = '';
  const btn = document.createElement('button');
  btn.innerText = 'Check In';
  btn.onclick = () => startCheckin(email, nameFromToken);
  actionDiv.appendChild(btn);
}

function startCheckin(email, nameFromToken) {
  if (!navigator.geolocation) {
    alert('Trình duyệt không hỗ trợ vị trí (geolocation).');
    return;
  }

  const manualName = document.getElementById('userName').value.trim();
  const finalName = manualName || nameFromToken || '';

  document.getElementById('status').innerText = 'Đang lấy vị trí...';

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    // build invisible form and submit by POST (navigational POST avoids CORS)
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'https://script.google.com/macros/s/AKfycbwD686lDtOb4UtwvKDOncEUu55C7z1Ie02WD3urL41-iIzjFheRf9-fodDA5tkZhbQiMw/exec'; // thay bằng URL web app của bạn
    form.style.display = 'none';

    const addField = (n, v) => {
      const i = document.createElement('input');
      i.type = 'hidden';
      i.name = n;
      i.value = v;
      form.appendChild(i);
    };

    addField('email', email);
    addField('name', finalName);
    addField('lat', lat);
    addField('lng', lng);

    document.body.appendChild(form);

    // Option 1: submit and stay on same page (target a new tab)
    // form.target = '_blank'; form.submit();

    // Option 2: submit in same tab, Apps Script returns HTML success message
    form.submit();

    // show message (Apps Script can return its own HTML success page)
    document.getElementById('status').innerText = 'Đã gửi dữ liệu. Nếu cần, cho phép mở cửa sổ mới.';
  }, err => {
    alert('Không lấy được vị trí: ' + (err.message || err.code));
    document.getElementById('status').innerText = '';
  }, { enableHighAccuracy: true, timeout: 10000 });
}
</script>
</body>
</html>
