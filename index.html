<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Check-in</title>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:20px;max-width:900px;margin:auto;background:#f7fafc}
    header{text-align:center;margin:18px 0 18px}
    .card{background:#fff;border-radius:10px;padding:18px;border:1px solid #e6eef6;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{color:var(--muted);margin:0 0 12px}
    #signinBtn{display:inline-block;padding:10px 14px;border-radius:8px;background:#fff;border:1px solid #d1e3ff;color:#0b63d6;text-decoration:none}
    .btn{padding:10px 14px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    .btn.red{background:#ef4444}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px}
    .status{margin-top:12px;color:#111}
    .hint{background:#fffbe6;border:1px solid #ffe8a0;padding:10px;border-radius:8px;margin-bottom:12px;color:#7a4c00}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <header>
    <h1>Check In</h1>
    <p class="lead">ƒêƒÉng nh·∫≠p Google ‚Üí Ch·ªânh t√™n (n·∫øu c·∫ßn) ‚Üí Check-in (redirect trang k·∫øt qu·∫£)</p>
  </header>

  <div class="card" id="card">
    <div id="beforeSignIn">
      <div class="hint" id="webviewHint" style="display:none"></div>
      <a id="signinBtn" href="#" role="button">üîí ƒêƒÉng nh·∫≠p b·∫±ng Google</a>
      <div class="status" id="status">Tr·∫°ng th√°i: Ch∆∞a ƒëƒÉng nh·∫≠p</div>
    </div>

    <div id="afterSignIn" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="small">Email: <b id="userEmail"></b></div>
        <button id="btnSignOut" class="btn red">ƒêƒÉng xu·∫•t</button>
      </div>
      <label for="userName" style="display:block;margin-top:8px;">T√™n hi·ªÉn th·ªã (c√≥ th·ªÉ s·ª≠a)</label>
      <input id="userName" type="text" placeholder="T√™n c·ªßa b·∫°n">
      <div style="margin-top:12px" class="row">
        <button id="btnCheckin" class="btn">Check in</button>
      </div>
      <div id="afterStatus" class="status"></div>
    </div>
  </div>

<script>
/* ===== C·∫§U H√åNH ===== */
const CLIENT_ID = '1046897683218-h0snmi82rtm2ep06fkepr4bt8eo1k84i.apps.googleusercontent.com';
const REDIRECT_URI = 'https://anhdvh99.github.io/Check_In_Web/';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwD686lDtOb4UtwvKDOncEUu55C7z1Ie02WD3urL41-iIzjFheRf9-fodDA5tkZhbQiMw/exec';
/* ==================== */

function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  return /(FBAN|FBAV|Instagram|Line|Zalo|MicroMessenger|Messenger)/i.test(ua);
}
function rand(n=16){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let s='';for(let i=0;i<n;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
function buildAuthUrl(){
  const nonce = rand(12);
  const state = rand(12);
  sessionStorage.setItem('oidc_nonce', nonce);
  sessionStorage.setItem('oidc_state', state);
  return 'https://accounts.google.com/o/oauth2/v2/auth'
      + '?client_id=' + encodeURIComponent(CLIENT_ID)
      + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI)
      + '&response_type=id_token'
      + '&scope=' + encodeURIComponent('openid email profile')
      + '&nonce=' + encodeURIComponent(nonce)
      + '&state=' + encodeURIComponent(state)
      + '&prompt=select_account';
}
function parseHashParams(){
  const hash = window.location.hash.substring(1);
  if(!hash) return null;
  return Object.fromEntries(hash.split('&').map(p=>p.split('=').map(decodeURIComponent)));
}
function decodeJwtPayload(id_token){
  try{
    const json = atob(id_token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'));
    return JSON.parse(decodeURIComponent(escape(json)));
  }catch{ return null; }
}
function clearUrlHash(){
  if(history && history.replaceState) history.replaceState('', document.title, window.location.pathname + window.location.search);
  else window.location.hash='';
}

const signinBtn = document.getElementById('signinBtn');
const statusEl = document.getElementById('status');
const webviewHint = document.getElementById('webviewHint');
const before = document.getElementById('beforeSignIn');
const after = document.getElementById('afterSignIn');
const userEmailEl = document.getElementById('userEmail');
const userNameEl = document.getElementById('userName');
const btnCheckin = document.getElementById('btnCheckin');
const afterStatus = document.getElementById('afterStatus');
const btnSignOut = document.getElementById('btnSignOut');

/* WebView hint */
if(isInAppBrowser()){
  webviewHint.style.display='block';
  webviewHint.innerHTML='B·∫°n ƒëang m·ªü trong ·ª©ng d·ª•ng (Zalo/Facebook...). ƒê·ªÉ ƒëƒÉng nh·∫≠p Google, h√£y m·ªü b·∫±ng Chrome/Safari.';
  const open = document.createElement('a'); open.href=window.location.href; open.target='_blank'; open.textContent='M·ªü trong tr√¨nh duy·ªát'; open.style.marginLeft='8px';
  webviewHint.appendChild(open);
}

/* Sign-in link */
function setSigninLink(){ signinBtn.href = buildAuthUrl(); }
setSigninLink();

/* Load: x·ª≠ l√Ω redirect t·ª´ Google */
window.addEventListener('load', ()=>{
  const hash = parseHashParams();
  if(hash && hash.id_token){
    const payload = decodeJwtPayload(hash.id_token);
    const savedNonce = sessionStorage.getItem('oidc_nonce');
    if(!payload /*|| payload.nonce !== savedNonce*/){
      statusEl.innerText = 'Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c token tr·∫£ v·ªÅ t·ª´ Google.';
      clearUrlHash(); setSigninLink(); return;
    }
    sessionStorage.setItem('user_id_token', hash.id_token);
    sessionStorage.setItem('user_email', payload.email||'');
    sessionStorage.setItem('user_name', payload.name||'');
    sessionStorage.setItem('login_time', String(Date.now()));
    clearUrlHash();
  }
  const email = sessionStorage.getItem('user_email');
  const name = sessionStorage.getItem('user_name');
  if(email){ showAfterLogin({email,name}); } else { statusEl.innerText='Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Google (redirect).'; before.style.display='block'; }
});

/* UI & actions */
function showAfterLogin(u){
  before.style.display='none';
  after.style.display='block';
  userEmailEl.textContent = u.email;
  userNameEl.value = u.name || '';
  statusEl.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p: ' + u.email;
}
function submitPostToAppsScript(formData){
  const form = document.createElement('form');
  form.method='POST'; form.action=APPS_SCRIPT_URL;
  for(const [k,v] of formData.entries()){
    const inp=document.createElement('input'); inp.type='hidden'; inp.name=k; inp.value=v; form.appendChild(inp);
  }
  document.body.appendChild(form);
  form.submit();
}

signinBtn.addEventListener('click', ()=> {/* link redirect s·∫µn */});

btnCheckin.addEventListener('click', ()=>{
  btnCheckin.disabled=true; afterStatus.textContent='ƒêang l·∫•y v·ªã tr√≠...';
  if(!navigator.geolocation){ afterStatus.textContent='Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'; btnCheckin.disabled=false; return; }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    afterStatus.textContent = `V·ªã tr√≠: ${lat.toFixed(6)}, ${lng.toFixed(6)} ‚Äî G·ª≠i...`;

    let ip='unknown'; try{ const r=await fetch('https://api.ipify.org?format=json'); ip=(await r.json()).ip||'unknown'; }catch{}
    const ua = navigator.userAgent;
    const email = sessionStorage.getItem('user_email')||'';
    const name = (userNameEl.value||'').trim();
    const idtoken = sessionStorage.getItem('user_id_token')||'';

    const data = new URLSearchParams();
    data.append('email', email);
    data.append('name', name);
    data.append('lat', lat.toString());
    data.append('lng', lng.toString());
    data.append('ip', ip);
    data.append('userAgent', ua);
    if(idtoken) data.append('id_token', idtoken);

    submitPostToAppsScript(data);
  }, err=>{
    afterStatus.textContent='L·∫•y v·ªã tr√≠ th·∫•t b·∫°i: ' + (err.message||err.code);
    btnCheckin.disabled=false;
  }, {enableHighAccuracy:true, timeout:15000, maximumAge:5000});
});

/* ƒêƒÉng xu·∫•t: xo√° session + c·ªë tho√°t Google ƒë·ªÉ l·∫ßn sau ch·ªçn t√†i kho·∫£n */
function signOutLocal(){
  sessionStorage.removeItem('user_id_token');
  sessionStorage.removeItem('user_email');
  sessionStorage.removeItem('user_name');
  sessionStorage.removeItem('login_time');
  after.style.display='none'; before.style.display='block';
  statusEl.textContent='ƒê√£ ƒëƒÉng xu·∫•t. ƒêƒÉng nh·∫≠p l·∫°i ƒë·ªÉ ti·∫øp t·ª•c.';
  setSigninLink();
}
function signOutGoogle(){
  try{
    const ifr=document.createElement('iframe');
    ifr.style.display='none'; ifr.src='https://accounts.google.com/Logout';
    document.body.appendChild(ifr);
    setTimeout(()=>{ document.body.removeChild(ifr); signOutLocal(); }, 1200);
  }catch{ signOutLocal(); }
}
btnSignOut.addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('ƒêƒÉng xu·∫•t ƒë·ªÉ d√πng t√†i kho·∫£n kh√°c?')) signOutGoogle(); });
</script>
</body>
</html>
